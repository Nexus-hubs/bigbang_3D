<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cosmic Timeline - Interactive 3D Journey</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', Arial, sans-serif;
            background: #000000;
            overflow: hidden;
            color: #FFFFFF;
            touch-action: none;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        /* Controls - Responsive */
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 15, 25, 0.97);
            padding: 15px 20px;
            border-radius: 20px;
            border: 2px solid rgba(0, 181, 201, 0.4);
            backdrop-filter: blur(20px);
            z-index: 100;
            width: calc(100% - 40px);
            max-width: 700px;
            box-shadow: 0 8px 32px rgba(0, 181, 201, 0.2);
        }

        #timeline-slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, #1a1a2e 0%, #00B5C9 var(--slider-value, 0%), #1a1a2e var(--slider-value, 0%));
            outline: none;
            border-radius: 4px;
            margin: 15px 0;
            cursor: pointer;
        }

        #timeline-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #00B5C9, #00D9F5);
            cursor: grab;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(0, 181, 201, 0.8), 0 0 40px rgba(0, 181, 201, 0.4);
            transition: transform 0.2s;
        }

        #timeline-slider::-webkit-slider-thumb:active {
            cursor: grabbing;
            transform: scale(1.2);
        }

        #timeline-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #00B5C9, #00D9F5);
            cursor: grab;
            border-radius: 50%;
            border: none;
            box-shadow: 0 0 20px rgba(0, 181, 201, 0.8);
        }

        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        button {
            background: linear-gradient(135deg, #00B5C9, #0095A8);
            color: #FFFFFF;
            border: none;
            padding: 10px 18px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 181, 201, 0.3);
            white-space: nowrap;
        }

        button:hover {
            background: linear-gradient(135deg, #00D9F5, #00B5C9);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 181, 201, 0.5);
        }

        button:active {
            transform: translateY(0);
        }

        .time-display {
            text-align: center;
            color: #00D9F5;
            font-size: 15px;
            font-weight: 600;
            margin-top: 10px;
            text-shadow: 0 0 10px rgba(0, 217, 245, 0.5);
        }

        /* Info Panel - Left Side */
        #info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(15, 15, 25, 0.97);
            padding: 20px;
            border-radius: 16px;
            border: 2px solid rgba(0, 181, 201, 0.4);
            backdrop-filter: blur(20px);
            max-width: 320px;
            z-index: 100;
            box-shadow: 0 8px 32px rgba(0, 181, 201, 0.2);
        }

        #info-panel h2 {
            color: #00D9F5;
            margin-bottom: 12px;
            font-size: 22px;
            text-shadow: 0 0 10px rgba(0, 217, 245, 0.5);
        }

        #info-panel p {
            color: #E8E8E8;
            line-height: 1.7;
            font-size: 14px;
        }

        /* Detailed Info Panel - Right Side */
        #detailed-info-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(15, 15, 25, 0.97);
            padding: 20px;
            border-radius: 16px;
            border: 2px solid rgba(0, 181, 201, 0.4);
            backdrop-filter: blur(20px);
            max-width: 350px;
            max-height: calc(100vh - 180px);
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 8px 32px rgba(0, 181, 201, 0.2);
        }

        #detailed-info-panel h3 {
            color: #00D9F5;
            margin-bottom: 10px;
            font-size: 18px;
            text-shadow: 0 0 10px rgba(0, 217, 245, 0.5);
        }

        .info-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 181, 201, 0.2);
        }

        .info-section:last-child {
            border-bottom: none;
        }

        .info-section h4 {
            color: #00B5C9;
            font-size: 14px;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-section p {
            color: #C0C0C0;
            font-size: 13px;
            line-height: 1.6;
        }

        .info-list {
            list-style: none;
            padding: 0;
        }

        .info-list li {
            color: #B0B0B0;
            font-size: 12px;
            line-height: 1.8;
            padding-left: 15px;
            position: relative;
        }

        .info-list li:before {
            content: "‚Üí";
            position: absolute;
            left: 0;
            color: #00B5C9;
        }

        /* Instructions - Mobile Friendly */
        #instructions {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(15, 15, 25, 0.97);
            padding: 12px 15px;
            border-radius: 16px;
            border: 2px solid rgba(0, 181, 201, 0.4);
            backdrop-filter: blur(20px);
            font-size: 12px;
            color: #E8E8E8;
            z-index: 100;
            box-shadow: 0 8px 32px rgba(0, 181, 201, 0.2);
        }

        #instructions div {
            margin: 4px 0;
            line-height: 1.4;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #00D9F5;
            font-size: 24px;
            font-weight: 600;
            text-shadow: 0 0 20px rgba(0, 217, 245, 0.8);
        }

        .sound-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0, 181, 201, 0.3);
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        #volume-slider {
            flex: 1;
            height: 5px;
            -webkit-appearance: none;
            appearance: none;
            background: #1a1a2e;
            outline: none;
            border-radius: 3px;
            cursor: pointer;
        }

        #volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, #00B5C9, #00D9F5);
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0, 181, 201, 0.6);
        }

        #volume-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, #00B5C9, #00D9F5);
            cursor: pointer;
            border-radius: 50%;
            border: none;
            box-shadow: 0 0 10px rgba(0, 181, 201, 0.6);
        }

        .sound-indicator {
            color: #00D9F5;
            font-size: 11px;
            min-width: 100px;
            text-align: right;
        }

        /* Scrollbar Styling */
        #detailed-info-panel::-webkit-scrollbar {
            width: 8px;
        }

        #detailed-info-panel::-webkit-scrollbar-track {
            background: rgba(26, 26, 46, 0.5);
            border-radius: 4px;
        }

        #detailed-info-panel::-webkit-scrollbar-thumb {
            background: rgba(0, 181, 201, 0.5);
            border-radius: 4px;
        }

        #detailed-info-panel::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 181, 201, 0.7);
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            #info-panel {
                max-width: 280px;
                padding: 15px;
                top: 15px;
                left: 15px;
            }

            #info-panel h2 {
                font-size: 18px;
            }

            #info-panel p {
                font-size: 13px;
            }

            #detailed-info-panel {
                max-width: 280px;
                padding: 15px;
                top: 15px;
                right: 15px;
                max-height: calc(100vh - 220px);
            }

            #controls {
                bottom: 15px;
                width: calc(100% - 30px);
                padding: 12px 15px;
            }

            .control-buttons {
                gap: 8px;
            }

            button {
                padding: 8px 12px;
                font-size: 12px;
            }

            #instructions {
                display: none; /* Hide on mobile to reduce clutter */
            }

            .time-display {
                font-size: 13px;
            }
        }

        @media (max-width: 480px) {
            #info-panel, #detailed-info-panel {
                max-width: calc(100vw - 30px);
                left: 15px;
                right: auto;
            }

            #detailed-info-panel {
                top: auto;
                bottom: 150px;
                max-height: 200px;
            }

            button {
                padding: 8px 10px;
                font-size: 11px;
            }
        }

        /* Touch device optimization */
        @media (hover: none) and (pointer: coarse) {
            button {
                min-height: 44px; /* iOS tap target recommendation */
            }
        }
    </style>
</head>
<body>
    <div id="canvas-container">
        <div class="loading">Loading Universe...</div>
    </div>

    <div id="info-panel">
        <h2 id="epoch-title">Big Bang</h2>
        <p id="epoch-description">The beginning of space, time, and everything we know.</p>
    </div>

    <div id="detailed-info-panel">
        <h3>Cosmic Insights</h3>
        <div id="detailed-content">
            <div class="info-section">
                <h4>Current Epoch</h4>
                <p id="detailed-epoch-info">Beginning of the universe from a singularity of infinite density and temperature.</p>
            </div>
            <div class="info-section">
                <h4>Key Facts</h4>
                <ul class="info-list" id="key-facts">
                    <li>All matter and energy originated from this point</li>
                    <li>Space itself began expanding</li>
                    <li>Time started at this moment</li>
                </ul>
            </div>
            <div class="info-section">
                <h4>What Happened Next</h4>
                <p id="next-events">The universe rapidly expanded and cooled, leading to the formation of fundamental particles.</p>
            </div>
        </div>
    </div>

    <div id="instructions">
        <div><strong style="color: #00D9F5;">Controls:</strong></div>
        <div>üñ±Ô∏è Drag to rotate view</div>
        <div>üîÑ Scroll to zoom</div>
        <div>‚èØÔ∏è Use controls below</div>
        <div>üîä Melodic soundscapes</div>
        <div>ü™ê Orbiting planets</div>
    </div>

    <div id="controls">
        <div class="control-buttons">
            <button id="play-btn">‚ñ∂ Play</button>
            <button id="pause-btn">‚è∏ Pause</button>
            <button id="reset-btn">‚Üª Reset</button>
            <button id="toggle-labels-btn">üè∑Ô∏è Labels</button>
            <button id="mute-btn">üîä Sound</button>
        </div>
        <input type="range" id="timeline-slider" min="0" max="100" value="0" step="0.1">
        <div class="time-display" id="time-display">Time: 0 years after Big Bang</div>
        <div class="sound-controls">
            <div class="volume-control">
                <span style="color: #00B5C9;">üîâ</span>
                <input type="range" id="volume-slider" min="0" max="100" value="40" step="1">
                <span style="color: #00D9F5;">üîä</span>
            </div>
            <span class="sound-indicator" id="sound-indicator">Ambient: Off</span>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // ============ ENHANCED MELODIC SOUND SYSTEM ============
        class CosmicSoundEngine {
            constructor() {
                this.audioContext = null;
                this.masterGain = null;
                this.currentOscillators = [];
                this.currentNoises = [];
                this.isInitialized = false;
                this.isMuted = true;
                this.volume = 0.4;

                // Musical scales for more melodic sounds
                this.scales = {
                    // Pentatonic scale (peaceful, no dissonance)
                    pentatonic: [261.63, 293.66, 329.63, 392.00, 440.00], // C, D, E, G, A
                    // Major scale intervals
                    major: [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88], // C major
                    // Ambient chord progressions
                    cosmicChord1: [130.81, 164.81, 196.00, 246.94], // C3, E3, G3, B3
                    cosmicChord2: [146.83, 185.00, 220.00, 277.18], // D3, F#3, A3, C#4
                    cosmicChord3: [174.61, 220.00, 261.63, 329.63], // F3, A3, C4, E4
                };
            }

            initialize() {
                if (this.isInitialized) return;

                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.masterGain = this.audioContext.createGain();
                    this.masterGain.connect(this.audioContext.destination);
                    this.masterGain.gain.value = 0;
                    this.isInitialized = true;
                } catch (e) {
                    console.warn('Web Audio API not supported:', e);
                }
            }

            createOscillator(frequency, type = 'sine', gain = 0.1, detune = 0) {
                if (!this.isInitialized) return null;

                const osc = this.audioContext.createOscillator();
                const oscGain = this.audioContext.createGain();

                osc.type = type;
                osc.frequency.value = frequency;
                osc.detune.value = detune;
                oscGain.gain.value = gain;

                // Add subtle vibrato for warmth
                const vibrato = this.audioContext.createOscillator();
                const vibratoGain = this.audioContext.createGain();
                vibrato.frequency.value = 3; // 3Hz vibrato
                vibratoGain.gain.value = 2; // Subtle depth

                vibrato.connect(vibratoGain);
                vibratoGain.connect(osc.detune);

                osc.connect(oscGain);
                oscGain.connect(this.masterGain);

                return { oscillator: osc, gain: oscGain, vibrato, vibratoGain };
            }

            createNoise(gain = 0.05, filterFreq = 1000) {
                if (!this.isInitialized) return null;

                const bufferSize = 2 * this.audioContext.sampleRate;
                const noiseBuffer = this.audioContext.createBuffer(1, bufferSize, this.audioContext.sampleRate);
                const output = noiseBuffer.getChannelData(0);

                for (let i = 0; i < bufferSize; i++) {
                    output[i] = Math.random() * 2 - 1;
                }

                const noise = this.audioContext.createBufferSource();
                noise.buffer = noiseBuffer;
                noise.loop = true;

                const noiseGain = this.audioContext.createGain();
                noiseGain.gain.value = gain;

                const filter = this.audioContext.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = filterFreq;
                filter.Q.value = 8;

                noise.connect(filter);
                filter.connect(noiseGain);
                noiseGain.connect(this.masterGain);

                return { noise, gain: noiseGain, filter };
            }

            stopAll() {
                this.currentOscillators.forEach(item => {
                    try {
                        if (item.vibrato) item.vibrato.stop();
                        item.oscillator.stop();
                    } catch (e) {}
                });
                this.currentNoises.forEach(item => {
                    try {
                        item.noise.stop();
                    } catch (e) {}
                });
                this.currentOscillators = [];
                this.currentNoises = [];
            }

            playEpochSound(epochTime) {
                if (!this.isInitialized || this.isMuted) return;

                this.stopAll();

                // Quantum Fluctuations (0-0.5%) - Ethereal high frequencies
                if (epochTime < 0.5) {
                    const noise = this.createNoise(0.025, 4000);
                    if (noise) {
                        noise.noise.start();
                        this.currentNoises.push(noise);
                    }

                    // Crystalline high tones using pentatonic scale
                    [1046.50, 1174.66, 1318.51].forEach((freq, i) => {
                        const osc = this.createOscillator(freq, 'sine', 0.008 - i * 0.001);
                        if (osc) {
                            osc.oscillator.start();
                            osc.vibrato.start();
                            this.currentOscillators.push(osc);
                        }
                    });
                }
                // Inflation (0.5-8%) - Deep resonant bass with harmonics
                else if (epochTime < 8) {
                    // Fundamental drone with perfect fifth harmony
                    const fundamentals = [
                        { freq: 65.41, gain: 0.06 },  // C2
                        { freq: 98.00, gain: 0.04 },  // G2 (perfect fifth)
                        { freq: 130.81, gain: 0.03 }  // C3 (octave)
                    ];

                    fundamentals.forEach(tone => {
                        const osc = this.createOscillator(tone.freq, 'sine', tone.gain);
                        if (osc) {
                            osc.oscillator.start();
                            osc.vibrato.start();
                            this.currentOscillators.push(osc);
                        }
                    });

                    const noise = this.createNoise(0.015, 600);
                    if (noise) {
                        noise.noise.start();
                        this.currentNoises.push(noise);
                    }
                }
                // CMB / Afterglow (8-15%) - Warm ambient pad
                else if (epochTime < 15) {
                    const noise = this.createNoise(0.02, 1500);
                    if (noise) {
                        noise.noise.start();
                        this.currentNoises.push(noise);
                    }

                    // Warm major chord - C major seventh
                    const warmChord = [
                        { freq: 130.81, gain: 0.025 }, // C3
                        { freq: 164.81, gain: 0.020 }, // E3
                        { freq: 196.00, gain: 0.018 }, // G3
                        { freq: 246.94, gain: 0.015 }  // B3
                    ];

                    warmChord.forEach(note => {
                        const osc = this.createOscillator(note.freq, 'sine', note.gain);
                        if (osc) {
                            osc.oscillator.start();
                            osc.vibrato.start();
                            this.currentOscillators.push(osc);
                        }
                    });
                }
                // Dark Ages (15-30%) - Minimal, meditative
                else if (epochTime < 30) {
                    const noise = this.createNoise(0.012, 400);
                    if (noise) {
                        noise.noise.start();
                        this.currentNoises.push(noise);
                    }

                    // Very low sustained tone with harmonic
                    const darkTones = [
                        { freq: 55.00, gain: 0.04 },  // A1
                        { freq: 82.41, gain: 0.025 }  // E2 (perfect fifth)
                    ];

                    darkTones.forEach(tone => {
                        const osc = this.createOscillator(tone.freq, 'sine', tone.gain);
                        if (osc) {
                            osc.oscillator.start();
                            osc.vibrato.start();
                            this.currentOscillators.push(osc);
                        }
                    });
                }
                // First Stars (30-50%) - Bright, twinkling major scale
                else if (epochTime < 50) {
                    // Bright major pentatonic melody
                    const starTones = [
                        { freq: 523.25, gain: 0.015 }, // C5
                        { freq: 587.33, gain: 0.013 }, // D5
                        { freq: 659.25, gain: 0.012 }, // E5
                        { freq: 783.99, gain: 0.010 }  // G5
                    ];

                    starTones.forEach(tone => {
                        const osc = this.createOscillator(tone.freq, 'sine', tone.gain);
                        if (osc) {
                            osc.oscillator.start();
                            osc.vibrato.start();
                            this.currentOscillators.push(osc);
                        }
                    });

                    // Gentle bass foundation
                    const bass = this.createOscillator(130.81, 'sine', 0.025); // C3
                    if (bass) {
                        bass.oscillator.start();
                        bass.vibrato.start();
                        this.currentOscillators.push(bass);
                    }
                }
                // Galaxy Formation (50-70%) - Flowing D minor chord
                else if (epochTime < 70) {
                    const noise = this.createNoise(0.018, 1200);
                    if (noise) {
                        noise.noise.start();
                        this.currentNoises.push(noise);
                    }

                    // D minor seventh chord (contemplative)
                    const galaxyChord = [
                        { freq: 146.83, gain: 0.022 }, // D3
                        { freq: 174.61, gain: 0.019 }, // F3
                        { freq: 220.00, gain: 0.017 }, // A3
                        { freq: 261.63, gain: 0.014 }  // C4
                    ];

                    galaxyChord.forEach(note => {
                        const osc = this.createOscillator(note.freq, 'sine', note.gain);
                        if (osc) {
                            osc.oscillator.start();
                            osc.vibrato.start();
                            this.currentOscillators.push(osc);
                        }
                    });
                }
                // Solar System (70-85%) - Harmonic planetary tones
                else if (epochTime < 85) {
                    // A major chord with extensions
                    const planetaryHarmonics = [
                        { freq: 110.00, gain: 0.024 }, // A2
                        { freq: 138.59, gain: 0.020 }, // C#3
                        { freq: 164.81, gain: 0.018 }, // E3
                        { freq: 220.00, gain: 0.015 }, // A3
                        { freq: 277.18, gain: 0.012 }  // C#4
                    ];

                    planetaryHarmonics.forEach(tone => {
                        const osc = this.createOscillator(tone.freq, 'sine', tone.gain);
                        if (osc) {
                            osc.oscillator.start();
                            osc.vibrato.start();
                            this.currentOscillators.push(osc);
                        }
                    });
                }
                // Present Day (85-100%) - Complex, rich harmony
                else {
                    const noise = this.createNoise(0.015, 1800);
                    if (noise) {
                        noise.noise.start();
                        this.currentNoises.push(noise);
                    }

                    // E major ninth chord (uplifting, complete)
                    const presentChord = [
                        { freq: 164.81, gain: 0.022 }, // E3
                        { freq: 207.65, gain: 0.019 }, // G#3
                        { freq: 246.94, gain: 0.017 }, // B3
                        { freq: 329.63, gain: 0.015 }, // E4
                        { freq: 369.99, gain: 0.012 }  // F#4 (9th)
                    ];

                    presentChord.forEach(note => {
                        const osc = this.createOscillator(note.freq, 'sine', note.gain);
                        if (osc) {
                            osc.oscillator.start();
                            osc.vibrato.start();
                            this.currentOscillators.push(osc);
                        }
                    });
                }
            }

            setVolume(value) {
                this.volume = value;
                if (this.masterGain && !this.isMuted) {
                    this.masterGain.gain.setTargetAtTime(value, this.audioContext.currentTime, 0.1);
                }
            }

            toggleMute() {
                this.isMuted = !this.isMuted;
                if (this.masterGain) {
                    const targetValue = this.isMuted ? 0 : this.volume;
                    this.masterGain.gain.setTargetAtTime(targetValue, this.audioContext.currentTime, 0.1);
                }
                return this.isMuted;
            }
        }

        const soundEngine = new CosmicSoundEngine();

        // ============ ENHANCED EPOCH DATA WITH DETAILED INFO ============
        const epochsDetailedData = {
            0: {
                title: "Quantum Fluctuations",
                description: "The Planck epoch - quantum foam of spacetime.",
                detailedInfo: "At the very beginning, the universe existed as a quantum singularity where space and time were not yet distinct. Quantum fluctuations at the Planck scale gave birth to the universe.",
                facts: [
                    "Temperature: ~10¬≥¬≤ Kelvin",
                    "All four fundamental forces unified",
                    "Gravity separates from other forces",
                    "Quantum effects dominate spacetime"
                ],
                nextEvents: "The universe will undergo exponential inflation, expanding faster than the speed of light."
            },
            0.5: {
                title: "Inflation",
                description: "Exponential expansion of the universe.",
                detailedInfo: "In a fraction of a second, the universe expanded by a factor of at least 10¬≤‚Å∂, smoothing out irregularities and explaining the universe's uniformity.",
                facts: [
                    "Duration: 10‚Åª¬≥‚Å∂ to 10‚Åª¬≥¬≤ seconds",
                    "Universe expands faster than light",
                    "Creates quantum fluctuations that seed galaxies",
                    "Explains cosmic flatness and uniformity"
                ],
                nextEvents: "After inflation, the universe enters a hot, dense state filled with elementary particles and radiation."
            },
            8: {
                title: "Afterglow Light Pattern",
                description: "Cosmic microwave background radiation becomes visible.",
                detailedInfo: "Electrons combine with nuclei to form atoms, making the universe transparent. Light from this era has been traveling through space for 13.8 billion years, now visible as microwave radiation.",
                facts: [
                    "Age: ~375,000 years",
                    "Temperature: ~3,000 Kelvin",
                    "First atoms (hydrogen, helium) form",
                    "Universe becomes transparent to light",
                    "CMB now detected at 2.7 Kelvin"
                ],
                nextEvents: "The universe enters a dark age with no light sources, only neutral hydrogen gas."
            },
            15: {
                title: "Dark Ages",
                description: "No stars yet - universe filled with neutral hydrogen.",
                detailedInfo: "A period of darkness between the CMB and first stars. The universe expanded and cooled, filled only with neutral hydrogen and helium gas, invisible in the darkness.",
                facts: [
                    "Duration: 400,000 to 400 million years",
                    "No light sources exist",
                    "Dark matter begins forming structures",
                    "Hydrogen gas cools and accumulates",
                    "Seeds of future galaxies take shape"
                ],
                nextEvents: "Gravity pulls hydrogen into dense clouds that will ignite as the first stars."
            },
            30: {
                title: "First Stars",
                description: "First generation of stars ignite.",
                detailedInfo: "Population III stars - massive, short-lived, and composed only of hydrogen and helium. These stellar furnaces forged the first heavy elements through nuclear fusion.",
                facts: [
                    "Age: ~400 million years",
                    "Stars 100-1000x mass of our Sun",
                    "No heavy elements yet",
                    "Created first carbon, oxygen, iron",
                    "Ended darkness with ultraviolet light"
                ],
                nextEvents: "These massive stars will explode as supernovae, seeding space with heavy elements needed for planets and life."
            },
            50: {
                title: "Galaxy Formation",
                description: "Galaxies begin to form and cluster.",
                detailedInfo: "Dark matter halos attracted gas and stars, forming the first galaxies. These early galaxies were smaller and more chaotic than modern ones, often colliding and merging.",
                facts: [
                    "Age: ~1 billion years",
                    "First spiral and elliptical galaxies",
                    "Supermassive black holes appear",
                    "Galaxies cluster under gravity",
                    "Heavy elements become abundant"
                ],
                nextEvents: "Galaxies continue growing through mergers and star formation, creating the cosmic web structure."
            },
            70: {
                title: "Solar System Birth",
                description: "Our solar system forms from nebular cloud.",
                detailedInfo: "A cloud of gas and dust collapsed under gravity, forming our Sun and planets. Rocky planets formed close to the Sun, while gas giants formed farther out where ice could exist.",
                facts: [
                    "Age: ~9 billion years (4.6 billion years ago)",
                    "Formed from supernova debris",
                    "Sun contains 99.86% of system mass",
                    "8 planets, dwarf planets, asteroids",
                    "Earth formed in habitable zone"
                ],
                nextEvents: "Planets continue forming and migrating. Life will emerge on Earth in the next billion years."
            },
            85: {
                title: "Dark Energy Era",
                description: "Dark energy dominates, accelerating expansion.",
                detailedInfo: "Around 5 billion years ago, dark energy began driving accelerated cosmic expansion. The universe's expansion started speeding up rather than slowing down as expected.",
                facts: [
                    "Age: ~10 billion years",
                    "Dark energy: ~68% of universe",
                    "Expansion accelerates",
                    "Galaxies moving apart faster",
                    "Universe will expand forever"
                ],
                nextEvents: "The universe will continue expanding, becoming colder and more diffuse over trillions of years."
            },
            100: {
                title: "Present Day",
                description: "Current era - age of observation and understanding.",
                detailedInfo: "We live 13.77 billion years after the Big Bang, in a universe of 2 trillion galaxies. Humanity has developed technology to observe the cosmic microwave background and peer back to the dawn of time.",
                facts: [
                    "Age: 13.77 billion years",
                    "~2 trillion galaxies observable",
                    "Humans evolved on Earth",
                    "We can observe to 380,000 years after Big Bang",
                    "Universe continues accelerating"
                ],
                nextEvents: "Stars will continue forming for trillions of years, followed by an era of slowly dying stars and black holes."
            }
        };

        // ============ THREE.JS SCENE ============
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000);
        scene.fog = new THREE.FogExp2(0x000000, 0.0008);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 10000);
        camera.position.set(0, 200, 400);
        camera.lookAt(0, 0, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Limit for performance
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // Remove loading screen
        document.querySelector('.loading').remove();

        // Cosmic epochs data
        const epochs = [
            { name: "Quantum Fluctuations", time: 0, years: "10‚Åª‚Å¥¬≥ seconds", position: 0, color: 0xFFFFFF, dataKey: 0 },
            { name: "Inflation", time: 0.5, years: "10‚Åª¬≥‚Å∂ to 10‚Åª¬≥¬≤ seconds", position: 10, color: 0xFFEFD5, dataKey: 0.5 },
            { name: "Afterglow Light Pattern", time: 8, years: "375,000 years", position: 80, color: 0xFF8C42, dataKey: 8 },
            { name: "Dark Ages", time: 15, years: "400,000 - 400M years", position: 150, color: 0x2A2A4A, dataKey: 15 },
            { name: "First Stars", time: 30, years: "~400 million years", position: 300, color: 0xFFD700, dataKey: 30 },
            { name: "Galaxy Formation", time: 50, years: "~1 billion years", position: 500, color: 0x6495ED, dataKey: 50 },
            { name: "Solar System Birth", time: 70, years: "~9 billion years", position: 700, color: 0xFF6B35, dataKey: 70 },
            { name: "Dark Energy Era", time: 85, years: "~10 billion years", position: 850, color: 0x9B59B6, dataKey: 85 },
            { name: "Present Day", time: 100, years: "13.77 billion years", position: 1000, color: 0x00D9F5, dataKey: 100 }
        ];

        // Create enhanced universe cone
        const createUniverseCone = () => {
            const group = new THREE.Group();

            // Main cone representing expanding universe
            const segments = 64;
            const geometry = new THREE.ConeGeometry(450, 1000, segments, 50, true);

            // Enhanced gradient material
            const material = new THREE.ShaderMaterial({
                vertexShader: `
                    varying vec2 vUv;
                    varying vec3 vPosition;
                    void main() {
                        vUv = uv;
                        vPosition = position;
                        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                    }
                `,
                fragmentShader: `
                    uniform float time;
                    varying vec2 vUv;
                    varying vec3 vPosition;

                    void main() {
                        float gradient = vPosition.y / 500.0 + 0.5;

                        vec3 color1 = vec3(1.0, 1.0, 1.0); // White (early universe)
                        vec3 color2 = vec3(1.0, 0.55, 0.26); // Orange (CMB)
                        vec3 color3 = vec3(0.16, 0.16, 0.29); // Dark blue (dark ages)
                        vec3 color4 = vec3(0.0, 0.85, 0.96); // Cyan (present)

                        vec3 color;
                        if (gradient < 0.08) {
                            color = mix(color1, color2, gradient / 0.08);
                        } else if (gradient < 0.25) {
                            color = mix(color2, color3, (gradient - 0.08) / 0.17);
                        } else {
                            color = mix(color3, color4, (gradient - 0.25) / 0.75);
                        }

                        // Enhanced noise for texture
                        float noise = fract(sin(dot(vUv * 100.0 + time * 0.1, vec2(12.9898, 78.233))) * 43758.5453);
                        color += noise * 0.03;

                        // Shimmer effect
                        float shimmer = sin(time + vPosition.y * 0.1) * 0.02 + 0.98;
                        color *= shimmer;

                        // Enhanced transparency gradient
                        float alpha = 0.5 + gradient * 0.4;

                        gl_FragColor = vec4(color, alpha);
                    }
                `,
                uniforms: {
                    time: { value: 0 }
                },
                transparent: true,
                side: THREE.DoubleSide,
                depthWrite: false
            });

            const cone = new THREE.Mesh(geometry, material);
            cone.rotation.x = -Math.PI / 2;
            cone.position.y = 0;
            group.add(cone);
            group.userData.coneMaterial = material;

            // Enhanced wireframe overlay
            const wireframeGeo = new THREE.ConeGeometry(453, 1000, 32, 20, true);
            const wireframeMat = new THREE.MeshBasicMaterial({
                color: 0x00D9F5,
                wireframe: true,
                transparent: true,
                opacity: 0.12
            });
            const wireframe = new THREE.Mesh(wireframeGeo, wireframeMat);
            wireframe.rotation.x = -Math.PI / 2;
            group.add(wireframe);

            // Enhanced particles for stars/galaxies
            const particlesGeometry = new THREE.BufferGeometry();
            const particlesCount = 6000;
            const positions = new Float32Array(particlesCount * 3);
            const colors = new Float32Array(particlesCount * 3);
            const sizes = new Float32Array(particlesCount);

            for (let i = 0; i < particlesCount; i++) {
                const t = Math.random();
                const radius = t * 450;
                const angle = Math.random() * Math.PI * 2;
                const y = (t - 0.5) * 1000;

                positions[i * 3] = Math.cos(angle) * radius * (0.9 + Math.random() * 0.2);
                positions[i * 3 + 1] = y;
                positions[i * 3 + 2] = Math.sin(angle) * radius * (0.9 + Math.random() * 0.2);

                // Enhanced color distribution
                if (t < 0.15) {
                    // Early universe - dark/dim
                    colors[i * 3] = 0.15;
                    colors[i * 3 + 1] = 0.15;
                    colors[i * 3 + 2] = 0.25;
                } else if (t < 0.5) {
                    // Mid universe - warm colors
                    colors[i * 3] = 0.6 + Math.random() * 0.4;
                    colors[i * 3 + 1] = 0.4 + Math.random() * 0.3;
                    colors[i * 3 + 2] = 0.2 + Math.random() * 0.2;
                } else {
                    // Recent universe - bright varied colors
                    colors[i * 3] = 0.5 + Math.random() * 0.5;
                    colors[i * 3 + 1] = 0.5 + Math.random() * 0.5;
                    colors[i * 3 + 2] = 0.5 + Math.random() * 0.5;
                }

                // Enhanced size variation
                sizes[i] = Math.random() * 4 + 0.5;
            }

            particlesGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            particlesGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            particlesGeometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));

            // Enhanced particle texture
            const canvas = document.createElement('canvas');
            canvas.width = 64;
            canvas.height = 64;
            const ctx = canvas.getContext('2d');

            const gradient = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
            gradient.addColorStop(0, 'rgba(255, 255, 255, 1)');
            gradient.addColorStop(0.2, 'rgba(255, 255, 255, 0.9)');
            gradient.addColorStop(0.5, 'rgba(255, 255, 255, 0.5)');
            gradient.addColorStop(0.8, 'rgba(255, 255, 255, 0.2)');
            gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');

            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 64, 64);

            const texture = new THREE.CanvasTexture(canvas);

            const particlesMaterial = new THREE.PointsMaterial({
                size: 3,
                vertexColors: true,
                transparent: true,
                opacity: 0.95,
                blending: THREE.AdditiveBlending,
                depthWrite: false,
                map: texture,
                sizeAttenuation: true
            });

            const particles = new THREE.Points(particlesGeometry, particlesMaterial);
            group.add(particles);

            return group;
        };

        const universeCone = createUniverseCone();
        scene.add(universeCone);

        // Add epoch markers in 3D space
        const markerGroup = new THREE.Group();
        let labelsVisible = true;

        epochs.forEach((epoch, index) => {
            const yPos = (epoch.time / 100 * 1000) - 500;
            const radius = (epoch.time / 100) * 450;

            // Enhanced marker sphere
            const markerGeo = new THREE.SphereGeometry(8, 32, 32);
            const markerMat = new THREE.MeshBasicMaterial({
                color: epoch.color,
                transparent: true,
                opacity: 0.95
            });
            const marker = new THREE.Mesh(markerGeo, markerMat);
            marker.position.set(radius, yPos, 0);
            markerGroup.add(marker);

            // Enhanced ring
            const ringGeo = new THREE.RingGeometry(10, 13, 32);
            const ringMat = new THREE.MeshBasicMaterial({
                color: 0x00D9F5,
                side: THREE.DoubleSide,
                transparent: true,
                opacity: 0.7,
                depthWrite: false
            });
            const ring = new THREE.Mesh(ringGeo, ringMat);
            ring.position.copy(marker.position);
            ring.rotation.x = Math.PI / 2;
            markerGroup.add(ring);

            // Enhanced glow
            const glowGeo = new THREE.SphereGeometry(14, 32, 32);
            const glowMat = new THREE.MeshBasicMaterial({
                color: epoch.color,
                transparent: true,
                opacity: 0.25,
                depthWrite: false
            });
            const glow = new THREE.Mesh(glowGeo, glowMat);
            glow.position.copy(marker.position);
            markerGroup.add(glow);
        });

        // Enhanced planets for solar system
        const solarSystemY = (70 / 100 * 1000) - 500;
        const solarSystemRadius = (70 / 100) * 450;

        const planetData = [
            { name: 'Mercury', size: 4, color: 0x8C7853, distance: -40, speed: 0.024 },
            { name: 'Venus', size: 6, color: 0xFFC649, distance: -60, speed: 0.018 },
            { name: 'Earth', size: 6.5, color: 0x4A90E2, distance: -85, speed: 0.012 },
            { name: 'Mars', size: 5, color: 0xE27B58, distance: -110, speed: 0.010 },
            { name: 'Jupiter', size: 14, color: 0xD4A574, distance: -155, speed: 0.006 },
            { name: 'Saturn', size: 11, color: 0xFAD5A5, distance: -200, speed: 0.005 },
            { name: 'Uranus', size: 8, color: 0x4FD0E0, distance: -240, speed: 0.004 },
            { name: 'Neptune', size: 8, color: 0x4166F5, distance: -280, speed: 0.003 }
        ];

        planetData.forEach((pData, i) => {
            const planetGeo = new THREE.SphereGeometry(pData.size, 32, 32);
            const planetMat = new THREE.MeshBasicMaterial({
                color: pData.color,
                transparent: true,
                opacity: 0.9
            });
            const planet = new THREE.Mesh(planetGeo, planetMat);
            planet.position.set(
                solarSystemRadius + pData.distance,
                solarSystemY,
                0
            );
            planet.userData = {
                speed: pData.speed,
                distance: pData.distance,
                baseRadius: solarSystemRadius,
                angle: Math.random() * Math.PI * 2
            };
            markerGroup.add(planet);

            // Enhanced planet glow
            const planetGlowGeo = new THREE.SphereGeometry(pData.size * 1.5, 32, 32);
            const planetGlowMat = new THREE.MeshBasicMaterial({
                color: pData.color,
                transparent: true,
                opacity: 0.25,
                depthWrite: false
            });
            const planetGlow = new THREE.Mesh(planetGlowGeo, planetGlowMat);
            planetGlow.position.copy(planet.position);
            planet.userData.glow = planetGlow;
            markerGroup.add(planetGlow);
        });

        scene.add(markerGroup);

        // Enhanced lighting
        const ambientLight = new THREE.AmbientLight(0xFFFFFF, 0.5);
        scene.add(ambientLight);

        const pointLight = new THREE.PointLight(0xFFFFFF, 1.2, 2500);
        pointLight.position.set(0, 500, 500);
        scene.add(pointLight);

        const pointLight2 = new THREE.PointLight(0x00D9F5, 0.6, 2500);
        pointLight2.position.set(0, -500, -500);
        scene.add(pointLight2);

        // Mouse and touch controls
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        let rotation = { x: 0, y: 0 };

        // Mouse events
        renderer.domElement.addEventListener('mousedown', (e) => {
            isDragging = true;
            previousMousePosition = { x: e.clientX, y: e.clientY };
        });

        renderer.domElement.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const deltaX = e.clientX - previousMousePosition.x;
                const deltaY = e.clientY - previousMousePosition.y;

                rotation.y += deltaX * 0.005;
                rotation.x += deltaY * 0.005;

                rotation.x = Math.max(-Math.PI / 3, Math.min(Math.PI / 3, rotation.x));

                previousMousePosition = { x: e.clientX, y: e.clientY };
            }
        });

        renderer.domElement.addEventListener('mouseup', () => {
            isDragging = false;
        });

        // Touch events for mobile
        let touchStartPos = { x: 0, y: 0 };

        renderer.domElement.addEventListener('touchstart', (e) => {
            e.preventDefault();
            isDragging = true;
            touchStartPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        }, { passive: false });

        renderer.domElement.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (isDragging && e.touches.length === 1) {
                const deltaX = e.touches[0].clientX - previousMousePosition.x;
                const deltaY = e.touches[0].clientY - previousMousePosition.y;

                rotation.y += deltaX * 0.008;
                rotation.x += deltaY * 0.008;

                rotation.x = Math.max(-Math.PI / 3, Math.min(Math.PI / 3, rotation.x));

                previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
        }, { passive: false });

        renderer.domElement.addEventListener('touchend', (e) => {
            e.preventDefault();
            isDragging = false;
        }, { passive: false });

        // Zoom with wheel and pinch
        renderer.domElement.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY * 0.5;
            camera.position.z += delta;
            camera.position.z = Math.max(200, Math.min(900, camera.position.z));
        }, { passive: false });

        // Animation controls
        let isPlaying = false;
        let currentTime = 0;
        const timeSlider = document.getElementById('timeline-slider');
        const timeDisplay = document.getElementById('time-display');
        const playBtn = document.getElementById('play-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const resetBtn = document.getElementById('reset-btn');
        const toggleLabelsBtn = document.getElementById('toggle-labels-btn');

        // Sound controls
        const muteBtn = document.getElementById('mute-btn');
        const volumeSlider = document.getElementById('volume-slider');
        const soundIndicator = document.getElementById('sound-indicator');

        // Initialize with moderate volume
        soundEngine.volume = 0.4;
        volumeSlider.value = 40;

        let lastEpochPlayed = -1;

        // UI sound effect helper
        function playUISound(frequency = 523.25, duration = 0.06) {
            if (!soundEngine.isInitialized) return;
            const ctx = soundEngine.audioContext;
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();

            osc.frequency.value = frequency;
            osc.type = 'sine';
            gain.gain.value = 0.025;

            osc.connect(gain);
            gain.connect(ctx.destination);

            osc.start();
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
            osc.stop(ctx.currentTime + duration);
        }

        function updateDetailedInfo(time) {
            let currentEpoch = epochs[0];
            for (let i = 0; i < epochs.length; i++) {
                if (time >= epochs[i].time) {
                    currentEpoch = epochs[i];
                } else {
                    break;
                }
            }

            const dataKey = currentEpoch.dataKey;
            const data = epochsDetailedData[dataKey];

            if (data) {
                document.getElementById('detailed-epoch-info').textContent = data.detailedInfo;

                const factsList = document.getElementById('key-facts');
                factsList.innerHTML = '';
                data.facts.forEach(fact => {
                    const li = document.createElement('li');
                    li.textContent = fact;
                    factsList.appendChild(li);
                });

                document.getElementById('next-events').textContent = data.nextEvents;
            }
        }

        function updateEpochInfo(time) {
            let currentEpoch = epochs[0];
            let epochIndex = 0;
            for (let i = 0; i < epochs.length; i++) {
                if (time >= epochs[i].time) {
                    currentEpoch = epochs[i];
                    epochIndex = i;
                } else {
                    break;
                }
            }

            document.getElementById('epoch-title').textContent = currentEpoch.name;
            document.getElementById('epoch-description').textContent = currentEpoch.description;

            // Update detailed info panel
            updateDetailedInfo(time);

            // Update time display
            if (time < 1) {
                timeDisplay.textContent = `Time: ${currentEpoch.years}`;
            } else {
                const years = (time / 100 * 13.77).toFixed(2);
                timeDisplay.textContent = `Time: ${years} billion years after Big Bang`;
            }

            // Update slider background gradient
            timeSlider.style.setProperty('--slider-value', `${time}%`);

            // Update sound if epoch changed
            if (epochIndex !== lastEpochPlayed && soundEngine.isInitialized && !soundEngine.isMuted) {
                lastEpochPlayed = epochIndex;
                soundEngine.playEpochSound(time);
                soundIndicator.textContent = `${currentEpoch.name}`;
            }
        }

        playBtn.addEventListener('click', () => {
            isPlaying = true;
            if (!soundEngine.isInitialized) {
                soundEngine.initialize();
                if (!soundEngine.isMuted) {
                    soundEngine.playEpochSound(currentTime);
                }
            }
            playUISound(659.25); // E5
        });

        pauseBtn.addEventListener('click', () => {
            isPlaying = false;
            playUISound(523.25); // C5
        });

        resetBtn.addEventListener('click', () => {
            currentTime = 0;
            timeSlider.value = 0;
            isPlaying = false;
            lastEpochPlayed = -1;
            updateEpochInfo(0);
            if (soundEngine.isInitialized && !soundEngine.isMuted) {
                soundEngine.playEpochSound(0);
            }
            playUISound(783.99); // G5
        });

        toggleLabelsBtn.addEventListener('click', () => {
            labelsVisible = !labelsVisible;
            markerGroup.visible = labelsVisible;
            playUISound(587.33); // D5
        });

        muteBtn.addEventListener('click', () => {
            if (!soundEngine.isInitialized) {
                soundEngine.initialize();
            }

            const isMuted = soundEngine.toggleMute();
            muteBtn.innerHTML = isMuted ? 'üîá Sound' : 'üîä Sound';

            if (!isMuted) {
                soundEngine.playEpochSound(currentTime);
                let currentEpoch = epochs[0];
                for (let i = 0; i < epochs.length; i++) {
                    if (currentTime >= epochs[i].time) {
                        currentEpoch = epochs[i];
                    } else {
                        break;
                    }
                }
                soundIndicator.textContent = `${currentEpoch.name}`;
                playUISound(698.46); // F5
            } else {
                soundEngine.stopAll();
                soundIndicator.textContent = 'Ambient: Off';
                playUISound(349.23); // F4
            }
        });

        volumeSlider.addEventListener('input', (e) => {
            const volume = parseFloat(e.target.value) / 100;
            soundEngine.setVolume(volume);
        });

        timeSlider.addEventListener('input', (e) => {
            currentTime = parseFloat(e.target.value);
            lastEpochPlayed = -1;
            updateEpochInfo(currentTime);
        });

        // Animation loop
        let animationFrameId;
        let animationTime = 0;

        function animate() {
            animationFrameId = requestAnimationFrame(animate);
            animationTime += 0.01;

            if (isPlaying) {
                currentTime += 0.04;
                if (currentTime > 100) {
                    currentTime = 100;
                    isPlaying = false;
                }
                timeSlider.value = currentTime;

                const newEpochIndex = epochs.findIndex((e, i) => {
                    return currentTime >= e.time && (i === epochs.length - 1 || currentTime < epochs[i + 1].time);
                });

                if (newEpochIndex !== lastEpochPlayed) {
                    updateEpochInfo(currentTime);
                }
            }

            // Update shader time
            if (universeCone.userData.coneMaterial) {
                universeCone.userData.coneMaterial.uniforms.time.value = animationTime;
            }

            // Rotate universe
            universeCone.rotation.y = rotation.y;
            universeCone.rotation.x = rotation.x;

            markerGroup.rotation.y = rotation.y;
            markerGroup.rotation.x = rotation.x;

            // Animate particles with gentle rotation
            const particles = universeCone.children[2];
            if (particles && particles.isPoints) {
                particles.rotation.y += 0.0003;
            }

            // Gentle camera sway
            const time = Date.now() * 0.0001;
            camera.position.x = Math.sin(time * 0.5) * 25;
            camera.lookAt(0, 0, 0);

            // Update marker glows and planets
            markerGroup.children.forEach((child, i) => {
                if (child.isMesh) {
                    // Animate glows with pulsing
                    if (child.geometry && child.geometry.type === 'SphereGeometry' &&
                        child.material.opacity < 0.35) {
                        child.scale.setScalar(1 + Math.sin(animationTime * 2 + i) * 0.12);
                    }

                    // Animate planets in orbit
                    if (child.userData && child.userData.speed) {
                        child.userData.angle += child.userData.speed * 0.01;
                        const orbitRadius = Math.abs(child.userData.distance);
                        child.position.x = child.userData.baseRadius + Math.cos(child.userData.angle) * orbitRadius;
                        child.position.z = Math.sin(child.userData.angle) * orbitRadius;

                        // Rotate planet on its axis
                        child.rotation.y += 0.01;

                        // Update glow position
                        if (child.userData.glow) {
                            child.userData.glow.position.copy(child.position);
                            child.userData.glow.rotation.copy(child.rotation);
                        }
                    }
                }
            });

            renderer.render(scene, camera);
        }

        animate();
        updateEpochInfo(0);

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (soundEngine.isInitialized) {
                soundEngine.stopAll();
            }
            cancelAnimationFrame(animationFrameId);
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        });
    </script>
</body>
</html>
